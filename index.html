<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Pronunciation Practice</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    textarea { width: 100%; height: 60px; }
    button { margin-right: 10px; padding: 8px 16px; }
    pre { background: #f4f4f4; padding: 10px; }
  </style>
</head>
<body>

  <h2>정답 문장 입력</h2>
  <textarea id="targetText" placeholder="예: apple 또는 I like to eat an apple."></textarea>

  <br><br>

  <button id="btnStart">Start</button>
  <button id="btnEnd" disabled>End</button>

  <h3>결과</h3>
  <pre id="result">아직 결과 없음</pre>

  <script>
    let stream;
    let recorder;
    let chunks = [];

    const btnStart = document.getElementById("btnStart");
    const btnEnd = document.getElementById("btnEnd");
    const result = document.getElementById("result");
    const targetInput = document.getElementById("targetText");

    btnStart.onclick = async () => {
      const targetText = targetInput.value.trim();
      if (!targetText) {
        alert("정답 문장을 먼저 입력하세요.");
        return;
      }

      chunks = [];
      result.textContent = "녹음 중...";

      stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      recorder = new MediaRecorder(stream, {
        mimeType: "audio/webm;codecs=opus"
      });

      recorder.ondataavailable = (e) => {
        if (e.data && e.data.size > 0) {
          chunks.push(e.data);
        }
      };

      recorder.onstop = async () => {
        const blob = new Blob(chunks, { type: "audio/webm" });
        const file = new File([blob], "recording.webm", { type: "audio/webm" });

        const form = new FormData();
        form.append("file", file);
        form.append("target_text", targetText); // 사용자 입력 정답 문장

        result.textContent = "채점 중...";

        try {
          const resp = await fetch("http://localhost:8000/grade", {
            method: "POST",
            body: form
          });

          const data = await resp.json();
          document.getElementById("result").textContent = data.feedback;
        } catch (err) {
          result.textContent = "에러 발생: " + err;
        }
      };

      recorder.start();
      btnStart.disabled = true;
      btnEnd.disabled = false;
    };

    btnEnd.onclick = () => {
      recorder.stop();
      stream.getTracks().forEach(t => t.stop());
      btnStart.disabled = false;
      btnEnd.disabled = true;
    };
  </script>

</body>
</html>
